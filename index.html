<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Servicios</title>
<meta name="theme-color" content="#e7e5d8" />
<link rel="icon" href="icons/dog-192.png" sizes="192x192" type="image/png" />
<style>
/* ===== GLOBAL ===== */
* { box-sizing:border-box;margin:0;padding:0; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto; background:#e7e5d8; min-height:100vh; padding:10px; }
.container{max-width:800px;margin:0 auto;padding:20px;}
h1{text-align:center;margin-bottom:20px;color:#373e2e;}button{cursor:pointer;}

/* ===== DATE CONTROLS ===== */
.date-strip {
    display: flex;
    overflow-x: auto;
    gap: 18px;
    padding: 15px 5px 20px;
    white-space: nowrap;
    scroll-snap-type: x mandatory;
    background: #e7e5d8;
    border-radius: 20px;
}

.date-item {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    scroll-snap-align: center;
}

.date-item span.dayname {
    font-size: 15px;
    color: #303021;
    font-weight: 500;
}

.date-item div.circle {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    font-weight: 600;
    color: #303021;
    border: 2px solid transparent;
    transition: 0.2s ease;
}

/* Selected date */
.date-item.active div.circle {
    background: #c1802a; /* your yellow-orange */
    color: #ffffff;
}

.date-strip::-webkit-scrollbar { display: none; }
.date-btn,.date-nav{ padding:18px 28px;font-size:22px;font-weight:700;border:none;border-radius:14px; cursor:pointer;background:#303021;color:#c6d197;transition:0.2s ease; }
.date-btn:hover,.date-nav:hover{transform:scale(1.05);box-shadow:0 6px 14px rgba(0,0,0,0.3);}
    
.month-header { text-align: center; font-size: 22px; font-weight: 700; color: #303021; margin-bottom: 10px; }

/* ===== SUMMARY ===== */
.summary{background:#d4cba8;padding:20px;border-radius:16px;margin-top:20px;margin-bottom:80px;}
#summaryContent{line-height:1.6;}

/* ===== MODALS ===== */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); z-index:3000; }
.dimmed { opacity: 0.3; pointer-events: none; transition: opacity 0.2s ease; }

/* SLIDE-UP PANEL (agenda) or SLIDE-IN PANEL (services) */
.modal-content {
    background:white;
    width:100%;
    height: calc(100vh - 80px); /* leave room for footer */
    max-height: none;
    border-radius:22px 22px 0 0;
    padding:18px;
    overflow-y:auto;
    box-shadow:0 4px 20px rgba(0,0,0,0.25);
    position: absolute;
    bottom: 0;
    animation: slideUp 0.30s ease-out;
}

.back-bottom-btn {
    position: sticky;
    bottom: 0;
    width: 100%;
    background: #f2f2f2;
    padding: 16px 0;
    text-align: center;
    font-size: 18px;
    border: none;
    border-radius: 16px 16px 0 0;
    margin-top: 20px;
}

/* Animations */
@keyframes slideUp {
  from { transform: translateY(100%); opacity: 1; }
  to { transform: translateY(0); opacity: 1; }
} to { transform: translateY(0); opacity: 1; } }
@keyframes slideDown { from { transform:translateY(-100%);} to { transform:translateY(0);} }

/* small inputs */
select,input[type="time"],input[type="number"],input[type="text"]{ width:100%;padding:12px 14px;margin-top:8px;margin-bottom:12px;border-radius:10px;border:2px solid #8a8252; background:#fcf9f1;font-size:16px;color:#303021; }

/* Buttons in modals */
.modal-buttons {
display: flex;
justify-content: flex-end;
gap: 12px;
margin-top: 18px;
padding: 12px 18px;
border-top: 1px solid #e0e0e0;
position: sticky;
bottom: 0;
background: #fff;
z-index: 10;
}.modal-buttons button{padding:10px 16px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer; background:#a53200;color:#f9e9ca;transition:0.2s;}
.modal-buttons button:hover{transform:scale(1.04);background:#8a2b00;}
.modal-buttons button.cancel{background:#666;color:#fff;}
.modal-buttons button.cancel:hover{background:#555;}

/* Service selection buttons */
.service-btn{padding:10px 14px;margin:6px;border:none;border-radius:12px;background:#a53200;color:#f9e9ca;font-weight:600;font-size:16px;cursor:pointer; transition:0.2s;}
.service-btn:hover{background:#8a2b00;transform:scale(1.05);}
.service-btn.selected{background:#8d4585;box-shadow:0 0 0 3px #d4cba8;}

/* Dog entry card */
.dog-entry{background:#f9f9f9;padding:12px;margin:10px 0;border-radius:12px;border:2px solid #8a8252;display:flex;justify-content:space-between;align-items:center;}
.dog-entry h4{color:#303021;margin-bottom:8px;}
.dog-entry .services-list{color:#666;font-size:14px;margin-top:5px;}
.dog-entry button.remove-btn{background:#d32f2f;color:white;padding:6px 12px;border:none;border-radius:6px;font-size:12px;margin-left:12px;}

/* small controls row */
.controls-row{display:flex;gap:10px;align-items:center;margin-top:6px;}
.controls-row .small-btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;}
.small-cancel{background:#666;color:#fff;}
.small-save{background:#8d4585;color:#fff;}

/* Checkbox styles */
.checkbox-wrapper{display:flex;align-items:center;gap:10px;margin:10px 0;}
.checkbox-wrapper input[type="checkbox"]{width:auto;margin:0;}
.checkbox-wrapper label{margin:0;cursor:pointer;}

/* ===== FOOTER ===== */
.footer-nav { position: fixed; bottom: 0px; left: 50%; transform: translateX(-50%); height: 60px; width: 90%; max-width: 480px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; background: #303021; border-radius: 9999px; z-index: 1500; }
.left-group,.right-group{display:flex;justify-content:space-between;width:120px;gap:0;}
.footer-nav .switch-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:6px 0;width:50px;background:transparent;border:none;cursor:pointer;border-radius:12px;}
.footer-nav .switch-btn img{width:30px;height:30px;opacity:0.9; filter: invert(89%) sepia(12%) saturate(335%) hue-rotate(26deg) brightness(92%) contrast(88%);} 
.footer-nav .switch-btn span{color:#c6d197;font-weight:600;font-size:12px;} 
.footer-nav .switch-btn.active span{color:#8d4585;font-weight:700;}

/* ===== FLOATING CENTER BUTTON ===== */
.floating-center-btn{position:fixed;bottom:30px;left:50%;transform:translateX(-50%); width:60px;height:60px;border-radius:50%;background:#c1802a;border:none; display:flex;justify-content:center;align-items:center;font-size:36px;font-weight:700;color:#c6d197;cursor:pointer;z-index:2500;}

/* ===== TARIFS TABLE ===== */
#tarifsSheet table{width:100%;border-collapse:collapse;margin-top:10px;}
#tarifsSheet th,#tarifsSheet td{border:1px solid #8a8252;padding:8px;text-align:center;font-size:16px;}
#tarifsSheet th{background:#303021;color:#c6d197;font-weight:700;}

/* ===== AGENDA ===== */
#agendaSheet .agenda-wrap{ animation: slideUp 0.25s ease-out; }
.agenda-block{margin:6px 0;padding:10px;border-radius:12px;background:#fff;}
.agenda-day{padding:12px;border-radius:12px;margin-bottom:8px;border:1px solid #e6e2cf;}
.agenda-day h3{margin-bottom:8px;color:#303021;}
.agenda-entry{display:flex;gap:12px;align-items:flex-start;padding:8px;border-radius:10px;margin:6px 0;background:#fbfbfa;border:1px solid #f0ede0;}
.entry-time{width:110px;font-weight:700;color:#303021;}
.entry-body{flex:1;}
.entry-services{font-size:14px;color:#666;margin-top:4px;}

/* Today's special styling */
.agenda-today{background:linear-gradient(180deg,#fff9ee,#fff);border:2px solid #c1802a;box-shadow:0 6px 18px rgba(193,128,42,0.12);} 

/* Past dates less visible */
.agenda-past{opacity:0.45;}

/* moon icon style fallback */
.moon{font-size:16px;margin-left:8px;}

</style>
</head>
<body>

<div class="container">
<h2 id="monthHeader" class="month-header"></h2>
<div class="date-strip" id="dateStrip"></div>
<div class="summary">
  <h3>Agenda:</h3>
  <div id="summaryContent">No hay servicios seleccionados.</div>
</div>
</div>

<!-- SERVICE MODAL -->
<div id="serviceModal" class="modal">
  <div class="modal-content" id="modalContent">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <h2 style="flex:1;margin-left:6px;">AÃ±adir Servicios</h2>
    </div>
    
    <div id="addedDogsContainer"></div>
    
    <label>
      <select id="dogSelect">
        <option value="">Seleccionar Perro</option>
      </select>
    </label>
    
    <div id="serviceButtonsContainer"></div>
    
    <div id="timeInputsContainer">
      <label>Inicio (opcional):</label>
      <input id="startTimeInput" type="time" />
      <label>Fin (opcional):</label>
      <input id="endTimeInput" type="time" />
      <div class="controls-row">
        <button id="addDogBtn" class="small-btn small-save">Guardar</button>
        <button id="cancelAddBtn" class="small-btn small-cancel">Cancelar</button>
      </div>
    </div>

    <!-- bottom back -->
    <button id="modalBackBtn" class="back-bottom-btn">Volver</button>
  </div>
</div>

<!-- TARIFS MODAL -->
<div id="tarifsSheet" class="modal">
  <div class="modal-content" id="tarifsContent">
    <h2>Tarifas por Perro (â‚¬)</h2>
    <table id="tarifsTable">
      <thead>
        <tr><th>Perro</th><th>DÃ­a</th><th>Noche</th><th>Paseo</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="modal-buttons">
      <button id="addDogTarifBtn">AÃ±adir Perro</button>
      <button id="saveTarifsBtn">Guardar</button>
      <button id="closeTarifsBtn" class="cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- AGENDA MODAL (slides up) -->
<div id="agendaSheet" class="modal">
<div class="modal-content agenda-wrap" id="agendaContent">
<h2>Agenda Completa</h2>
<div id="agendaContainer"></div>
<div class="modal-buttons">
<button id="closeAgendaBtn" class="cancel">Cerrar</button>
</div>
</div>
</div>

<!-- FOOTER -->
<footer class="footer-nav">
  <div class="left-group">
    <button class="switch-btn tarifs" id="tarifsBtn"><img src="icons/walk.svg"><span>Tarifas</span></button>
    <button class="switch-btn accounts" id="accountsBtn"><img src="icons/accounts.svg"><span>Cuentas</span></button>
  </div>
  <div class="right-group">
    <button class="switch-btn profile" id="profileBtn"><img src="icons/vet.svg"><span>Perfiles</span></button>
    <button class="switch-btn calendar" id="calendarBtn"><img src="icons/agenda.svg"><span>Agenda</span></button>
  </div>
</footer>

<button class="floating-center-btn" id="centralBtn">+</button>

<script>
// ===== GLOBAL STATE =====
let currentDate = new Date();
const defaultDogs = ["Nina","Carmela","Pancho","Pablo","Lili","Jugnia","Leo","India","Kimchi","Cuatri","Tristona y Belona","Neo","Briso","Zaspi","R&H"];
let allDogs = JSON.parse(localStorage.getItem('allDogs')) || defaultDogs;
let selections = JSON.parse(localStorage.getItem('selections')) || {};
let tarifs = JSON.parse(localStorage.getItem('tarifs')) || {};
let currentDogSelection = { dog: null, services: [], start: '', end: '' };
const formatDate = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;

// ===== DATE STRIP =====
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const dateStrip = document.getElementById("dateStrip");
const DAYS_TO_SHOW = 365; // forward/back from today
let allDates = [];

function generateDates(centerDate = new Date()){
    allDates = [];
    for(let i=-DAYS_TO_SHOW;i<=DAYS_TO_SHOW;i++){
        const d = new Date(centerDate);
        d.setDate(centerDate.getDate() + i);
        allDates.push(d);
    }
}

function buildFullDateStrip(centerDate = new Date()){
    generateDates(centerDate);
    dateStrip.innerHTML = '';
    dateStrip.style.scrollSnapType = "x mandatory";

    allDates.forEach(d=>{
        const div = document.createElement("div");
        div.className = "date-item";
        if(d.toDateString() === centerDate.toDateString()) div.classList.add("active");
        div.innerHTML = `
            <span class="dayname">${dayNames[d.getDay()]}</span>
            <div class="circle">${d.getDate()}</div>
        `;
        dateStrip.appendChild(div);
    });

    setTimeout(()=>scrollToDate(centerDate),50);
}

function scrollToDate(targetDate){
    const items = dateStrip.querySelectorAll(".date-item");
    for(let i=0;i<allDates.length;i++){
        if(allDates[i].toDateString() === targetDate.toDateString()){
            const item = items[i];
            dateStrip.scrollLeft = item.offsetLeft - dateStrip.offsetWidth/2 + item.offsetWidth/2;
            break;
        }
    }
}

function updateMonthHeader(date){ document.getElementById("monthHeader").textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`; }

// Dragging behaviour
let isDragging = false; let startX, scrollLeft;
dateStrip.addEventListener('mousedown', (e)=>{ isDragging = true; startX = e.pageX - dateStrip.offsetLeft; scrollLeft = dateStrip.scrollLeft; });
dateStrip.addEventListener('touchstart', (e)=>{ isDragging = true; startX = e.touches[0].pageX - dateStrip.offsetLeft; scrollLeft = dateStrip.scrollLeft; });
dateStrip.addEventListener('mousemove', (e)=>{ if(!isDragging) return; e.preventDefault(); const x = e.pageX - dateStrip.offsetLeft; const walk = (x - startX); dateStrip.scrollLeft = scrollLeft - walk; });
dateStrip.addEventListener('touchmove', (e)=>{ if(!isDragging) return; const x = e.touches[0].pageX - dateStrip.offsetLeft; const walk = (x - startX); dateStrip.scrollLeft = scrollLeft - walk; });

dateStrip.addEventListener('mouseup', snapToClosest);
dateStrip.addEventListener('mouseleave', snapToClosest);
dateStrip.addEventListener('touchend', snapToClosest);

function snapToClosest(){ if(!isDragging) return; isDragging = false; const stripRect = dateStrip.getBoundingClientRect(); const stripCenter = stripRect.left + stripRect.width/2; let closestIdx = 0; let closestDist = Infinity; dateStrip.querySelectorAll('.date-item').forEach((item,i)=>{ const itemRect = item.getBoundingClientRect(); const itemCenter = itemRect.left + itemRect.width/2; const dist = Math.abs(stripCenter - itemCenter); if(dist < closestDist){ closestDist = dist; closestIdx = i; } }); const targetItem = dateStrip.children[closestIdx]; dateStrip.scrollTo({ left: targetItem.offsetLeft - dateStrip.offsetWidth/2 + targetItem.offsetWidth/2, behavior: 'smooth' }); dateStrip.querySelectorAll('.date-item').forEach(d=>d.classList.remove('active')); targetItem.classList.add('active'); currentDate = allDates[closestIdx]; updateMonthHeader(currentDate); updateSummary(); }

// ===== SERVICE MODAL =====
const serviceModal = document.getElementById('serviceModal');
const dogSelect = document.getElementById('dogSelect');
const serviceButtonsContainer = document.getElementById('serviceButtonsContainer');
const timeInputsContainer = document.getElementById('timeInputsContainer');
const addedDogsContainer = document.getElementById('addedDogsContainer');

// open modal
document.getElementById('centralBtn').onclick = ()=>{
    currentDogSelection = { dog: null, services: [], start: '', end: '' };
    dogSelect.innerHTML = '<option value="">Seleccionar Perro</option>';
    allDogs.forEach(d=>{ const opt = document.createElement('option'); opt.value = d; opt.textContent = d; dogSelect.appendChild(opt); });
    serviceButtonsContainer.innerHTML='';
    timeInputsContainer.style.display='none';
    addedDogsContainer.innerHTML='';
    serviceModal.style.display='block';
    refreshServiceModalForCurrentDate();
};

// back buttons close popup (both top and bottom)
const topBack = document.getElementById('backBtn');
if(topBack) topBack.addEventListener('click', ()=>{ serviceModal.style.display='none'; });
const bottomBack = document.getElementById('modalBackBtn');
if(bottomBack) bottomBack.addEventListener('click', ()=>{ serviceModal.style.display='none'; });

// Dog selection
dogSelect.onchange = ()=>{ currentDogSelection.dog = dogSelect.value || null; renderServiceButtons(); };

function renderServiceButtons() {
    serviceButtonsContainer.innerHTML = '';
    if (!currentDogSelection.dog) return;
    
    const services = ['+ GuarderÃ­a', '+ Noche', '+ Paseo'];
    services.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'service-btn';
        btn.title = s;

        btn.addEventListener('click', () => {
            btn.classList.toggle('selected');
            const idx = currentDogSelection.services.indexOf(s);
            if (idx > -1) currentDogSelection.services.splice(idx, 1);
            else currentDogSelection.services.push(s);
            // show time inputs if any non-overnight selected; time fields are optional
            const showTime = currentDogSelection.services.some(x => x !== 'Overnight');
            timeInputsContainer.style.display = showTime ? 'block' : 'block'; // keep visible (optional)
        });

        serviceButtonsContainer.appendChild(btn);
    });
}

// cancel single add
const cancelAddBtn = document.getElementById('cancelAddBtn');
if(cancelAddBtn) cancelAddBtn.addEventListener('click', ()=>{ currentDogSelection = { dog:null, services:[], start:'', end:'' }; dogSelect.value=''; serviceButtonsContainer.innerHTML=''; document.getElementById('startTimeInput').value=''; document.getElementById('endTimeInput').value=''; });

// add single dog immediately (no global save)
const addDogBtn = document.getElementById('addDogBtn');
if(addDogBtn) addDogBtn.addEventListener('click', ()=>{
    if(!currentDogSelection.dog || currentDogSelection.services.length===0){ alert('Selecciona un perro y al menos un servicio'); return; }
    const startVal = document.getElementById('startTimeInput').value;
    const endVal = document.getElementById('endTimeInput').value;
    // allow no time entry (optional). store empty strings when not provided.
    currentDogSelection.start = startVal || '';
    currentDogSelection.end = endVal || '';

    // save immediately to selections for currentDate
    const dateKey = formatDate(currentDate);
    if(!selections[dateKey]) selections[dateKey] = {};
    currentDogSelection.services.forEach(s=>{
        const key = `${currentDogSelection.dog}_${s}`;
        selections[dateKey][key] = { selected:true, start: currentDogSelection.start, end: currentDogSelection.end };
    });
    localStorage.setItem('selections', JSON.stringify(selections));

    // show in added list
    renderAddedDogsForDate(dateKey);
    updateSummary();

    // reset form
    currentDogSelection = { dog:null, services:[], start:'', end:'' };
    dogSelect.value=''; serviceButtonsContainer.innerHTML=''; document.getElementById('startTimeInput').value=''; document.getElementById('endTimeInput').value='';
});

function renderAddedDogsForDate(dateKey){
    addedDogsContainer.innerHTML='';
    const entries = selections[dateKey] || {};
    Object.entries(entries).forEach(([k,v])=>{
        if(!v.selected) return;
        const [dog, service] = k.split('_');
        const timeStr = v.start || v.end ? ` ${v.start || ''}${v.start && v.end ? ' - ' : ''}${v.end || ''}` : '';
        const card = document.createElement('div');
        card.className = 'dog-entry';
        card.innerHTML = `<div><strong>${dog}</strong><div class="services-list">${service}${timeStr}${service==='Overnight' ? ' ðŸŒ™' : ''}</div></div><div><button class="remove-btn">Eliminar</button></div>`;
        const removeBtn = card.querySelector('.remove-btn');
        if(removeBtn) removeBtn.addEventListener('click', ()=>{ delete selections[dateKey][k]; localStorage.setItem('selections', JSON.stringify(selections)); renderAddedDogsForDate(dateKey); updateSummary(); });
        addedDogsContainer.appendChild(card);
    });
}

// show existing for current date when modal opens or date changes
function refreshServiceModalForCurrentDate(){ const dateKey = formatDate(currentDate); renderAddedDogsForDate(dateKey); }

// ===== SUMMARY =====
function updateSummary(){
    const dateKey = formatDate(currentDate);
    const div = document.getElementById('summaryContent');
    if(!selections[dateKey]){ div.textContent = 'No hay servicios seleccionados.'; return; }

    const groups = {};
    Object.entries(selections[dateKey]).forEach(([key,val])=>{
        if(!val.selected) return;
        const [dog, service] = key.split('_');
        if(!groups[dog]) groups[dog]=[];
        const timeStr = val.start || val.end ? ` (${val.start || ''}${val.start && val.end ? ' â†’ ' : ''}${val.end || ''})` : '';
        groups[dog].push(`${service}${service==='Overnight' ? ' ðŸŒ™' : ''}${timeStr}`);
    });

    let html='';
    for(let dog in groups){
        html += `<strong>${dog}</strong><br>`;
        groups[dog].forEach(s=>{ html+=`â€¢ ${s}<br>`; });
        html+='<br>';
    }
    div.innerHTML = html || 'No hay servicios seleccionados.';
}

// ===== TARIFS MODAL =====
const tarifsSheet = document.getElementById('tarifsSheet');
const tarifsTableBody = document.querySelector('#tarifsTable tbody');

function loadTarifs(){
    tarifsTableBody.innerHTML='';
    allDogs.forEach(d=>{
        if(!tarifs[d]) tarifs[d]={day:10,night:10,walk:10};
        const row = document.createElement('tr');
        row.innerHTML = `<td>${d}</td><td><input type="number" min="0" value="${tarifs[d].day}"></td><td><input type="number" min="0" value="${tarifs[d].night}"></td><td><input type="number" min="0" value="${tarifs[d].walk}"></td>`;
        tarifsTableBody.appendChild(row);
    });
}
loadTarifs();

document.getElementById('tarifsBtn').onclick = ()=>{ tarifsSheet.style.display='block'; document.getElementById('tarifsContent').style.animation = 'slideUp 0.30s ease-out'; };
document.getElementById('closeTarifsBtn').onclick = ()=>{ tarifsSheet.style.display='none'; };
document.getElementById('saveTarifsBtn').onclick = ()=>{ [...tarifsTableBody.querySelectorAll('tr')].forEach(tr=>{ const dog = tr.children[0].textContent; tarifs[dog] = { day: Number(tr.children[1].querySelector('input').value), night: Number(tr.children[2].querySelector('input').value), walk: Number(tr.children[3].querySelector('input').value) }; }); localStorage.setItem('tarifs',JSON.stringify(tarifs)); tarifsSheet.style.display='none'; };
document.getElementById('addDogTarifBtn').onclick = ()=>{ const name = prompt("Introduce el nombre del perro:"); if(!name) return; if(allDogs.includes(name)){ alert("Perro ya existe."); return; } allDogs.push(name); localStorage.setItem('allDogs',JSON.stringify(allDogs)); tarifs[name] = {day:10, night:10, walk:10}; loadTarifs(); };

// ===== AGENDA MODAL =====
const agendaSheet = document.getElementById('agendaSheet');
const agendaContainer = document.getElementById('agendaContainer');


document.getElementById('calendarBtn').onclick = ()=>{ openAgenda(); };
document.getElementById('closeAgendaBtn').onclick = ()=>{ agendaSheet.style.display='none'; };


function openAgenda(){
renderAgenda();
agendaSheet.style.display='block';
document.getElementById('agendaContent').style.animation = 'slideUp 0.25s ease-out';
}


function renderAgenda() {
    agendaContainer.innerHTML = '';
    const dateKeys = Object.keys(selections);
    if(dateKeys.length === 0){
        agendaContainer.innerHTML = '<p>No hay servicios programados.</p>';
        return;
    }

    const now = new Date();
    now.setHours(0,0,0,0);

    let todayBlock = null;
    const future = [];

    dateKeys.forEach(k => {
        const [da, ma, ya] = k.split('/').map(Number);
        const dt = new Date(ya, ma-1, da);
        if(dt.getTime() === now.getTime()) todayBlock = k;
        else if(dt > now) future.push(k);
    });

    // Today's block
    if(todayBlock){
        const todaySection = document.createElement('div');
        todaySection.className = 'agenda-block agenda-today';
        const dayDiv = buildAgendaDay(todayBlock, false, true);
        todaySection.appendChild(dayDiv);
        agendaContainer.appendChild(todaySection);
    }

    // Future block
    future.forEach(fk => {
        const futureSection = document.createElement('div');
        futureSection.className = 'agenda-block';
        const dayDiv = buildAgendaDay(fk, false);
        futureSection.appendChild(dayDiv);
        agendaContainer.appendChild(futureSection);
    });
}

    function buildAgendaDay(dateKey, isPast=false, isToday=false){
    const dayDiv = document.createElement('div');
    dayDiv.className = 'agenda-day';
    if(isPast) dayDiv.classList.add('agenda-past');
    
    const header = document.createElement('h3');
    header.textContent = dateKey + (isToday ? ' (Hoy)' : '');
    dayDiv.appendChild(header);

    const entries = selections[dateKey] || {};
    Object.entries(entries).forEach(([key, val]) => {
        if(!val.selected) return;
        const [dog, service] = key.split('_');
        const entry = document.createElement('div');
        entry.className = 'agenda-entry';
        const timeStr = val.start || val.end ? ` ${val.start || ''}${val.start && val.end ? ' â†’ ' : ''}${val.end || ''}` : '';
        entry.innerHTML = `<div class="entry-time">${dog}</div><div class="entry-body">${service}${service==='Overnight' ? ' ðŸŒ™' : ''}${timeStr}</div>`;
        dayDiv.appendChild(entry);
    });

    return dayDiv;
}

// ===== INITIAL CALLS =====
buildFullDateStrip(currentDate);
updateMonthHeader(currentDate);
updateSummary();

// when opening service modal for a date, refresh added list
// listen to date strip clicks to update currentDate and refresh summary
dateStrip.addEventListener('click', (e)=>{ // find nearest .date-item with center snapping already handled in drag; here capture click
    const item = e.target.closest('.date-item'); if(!item) return; const idx = Array.from(dateStrip.children).indexOf(item); if(idx>=0){ currentDate = allDates[idx]; dateStrip.querySelectorAll('.date-item').forEach(d=>d.classList.remove('active')); item.classList.add('active'); updateMonthHeader(currentDate); updateSummary(); refreshServiceModalForCurrentDate(); }
});

// open service modal should also show existing for date
document.getElementById('centralBtn').addEventListener('click', ()=>{ refreshServiceModalForCurrentDate(); });

// open agenda via button
document.getElementById('calendarBtn').addEventListener('click', ()=>{ openAgenda(); });

</script>

</body>
</html>
