<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Servicios</title>
<meta name="theme-color" content="#e7e5d8" />
<link rel="icon" href="icons/dog-192.png" sizes="192x192" type="image/png" />
<style>
/* ===== GLOBAL ===== */
* { box-sizing:border-box;margin:0;padding:0; }
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto; background:#e7e5d8; min-height:100vh; padding:10px; }
.container{max-width:800px;margin:0 auto;padding:20px;}
h1{text-align:center;margin-bottom:20px;color:#373e2e;}button{cursor:pointer;}

/* ===== DATE CONTROLS ===== */
.date-strip {
    display: flex;
    overflow-x: auto;
    gap: 18px;
    padding: 15px 5px 20px;
    white-space: nowrap;
    scroll-snap-type: x mandatory;
    background: #e7e5d8;
    border-radius: 20px;
}

.date-item {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    scroll-snap-align: center;
}

.date-item span.dayname {
    font-size: 15px;
    color: #303021;
    font-weight: 500;
}

.date-item div.circle {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    font-weight: 600;
    color: #303021;
    border: 2px solid transparent;
    transition: 0.2s ease;
}

/* Selected date */
.date-item.active div.circle {
    background: #c1802a; /* your yellow-orange */
    color: #ffffff;
}

.date-strip::-webkit-scrollbar { display: none; }
.date-btn,.date-nav{ padding:18px 28px;font-size:22px;font-weight:700;border:none;border-radius:14px; cursor:pointer;background:#303021;color:#c6d197;transition:0.2s ease; }
.date-btn:hover,.date-nav:hover{transform:scale(1.05);box-shadow:0 6px 14px rgba(0,0,0,0.3);}
    
.month-header { text-align: center; font-size: 22px; font-weight: 700; color: #303021; margin-bottom: 10px; }

/* ===== SUMMARY ===== */
.summary{background:#d4cba8;padding:20px;border-radius:16px;margin-top:20px;margin-bottom:80px;}
#summaryContent{line-height:1.6;}
    .summary-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}

.summary-time {
  flex: 0 0 auto;      /* take only the space needed */
  min-width: 60px;     /* ensures small screens still show time clearly */
  font-weight: 600;
  white-space: nowrap;  /* prevents time from breaking into 2 lines */
}

.summary-text {
  flex: 1 1 auto;      /* dog + service can wrap if needed */
}


/* ===== MODALS ===== */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); z-index:3000; }
.dimmed { opacity: 0.3; pointer-events: none; transition: opacity 0.2s ease; }

/* SLIDE-UP PANEL (agenda) or SLIDE-IN PANEL (services) */
.modal-content {
    background:white;
    max-height: none;
    border-radius:22px 22px 0 0;
    overflow-y:auto;
    box-shadow:0 4px 20px rgba(0,0,0,0.25);
    position: relative; /* required for absolute positioning of the button */
    bottom: 0;
    animation: slideUp 0.30s ease-out;
    width: 100%;
    height: calc(100vh - env(safe-area-inset-bottom));
    padding:24px 20px calc(16px + env(safe-area-inset-bottom));
}
    
.back-bottom-btn {
    position: sticky;
    bottom: env(safe-area-inset-bottom, 0); /* sticky above phone navigation */
    left: 0;
    width: 100%;
    background: #f2f2f2;
    padding: 16px 0;
    text-align: center;
    font-size: 18px;
    border: none;
    border-radius: 16px 16px 0 0;
}
    
/* Animations */
@keyframes slideUp {
  from { transform: translateY(100%); opacity: 1; }
  to { transform: translateY(0); opacity: 1; }
} to { transform: translateY(0); opacity: 1; } }
@keyframes slideDown { from { transform:translateY(-100%);} to { transform:translateY(0);} }

/* small inputs */
select,input[type="time"],input[type="number"],input[type="text"]{ width:100%;padding:12px 14px;margin-top:8px;margin-bottom:12px;border-radius:10px;border:2px solid #8a8252; background:#fcf9f1;font-size:16px;color:#303021; }

/* Buttons in modals */
.modal-buttons {
display: flex;
justify-content: flex-end;
gap: 12px;
margin-top: 18px;
margin-bottom: 0 !important;
padding: 12px 18px;
border-top: 1px solid #e0e0e0;
position: sticky;
bottom: 0;
background: #fff;
z-index: 10;
}
    
.modal-buttons button{padding:10px 16px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer; background:#a53200;color:#f9e9ca;transition:0.2s;}
.modal-buttons button:hover{transform:scale(1.04);background:#8a2b00;}
.modal-buttons button.cancel{background:#666;color:#fff;}
.modal-buttons button.cancel:hover{background:#555;}
   
/* Service selection buttons */
.service-btn{padding:10px 14px;margin:6px;border:none;border-radius:12px;background:#b7e3c2;color:#195928;font-weight:600;font-size:16px;cursor:pointer; transition:0.2s;}
.service-btn.selected{background:#195928;box-shadow:0 0 0 3px #5aaf6e; color: #eaf6ed}

/* Dog entry card */
.dog-entry{background:#f9f9f9;padding:12px;margin:10px 0;border-radius:12px;border:2px solid #8a8252;display:flex;justify-content:space-between;align-items:center;}
.dog-entry h4{color:#303021;margin-bottom:8px;}
.dog-entry .services-list{color:#666;font-size:14px;margin-top:5px;}
.dog-entry button.remove-btn{background:#d32f2f;color:white;padding:6px 12px;border:none;border-radius:6px;font-size:12px;margin-left:12px;}

/* small controls row */
.controls-row{display:flex;gap:10px;align-items:center;margin-top:6px;}
.controls-row .small-btn{padding:8px 12px;border-radius:8px;border:none;font-weight:700;}
.small-cancel{background:#5a5a5a;color:#f2f2f2;}
.small-save{background:#f2f2f2;color:#5a5a5a;}
 
/* Checkbox styles */
.checkbox-wrapper{display:flex;align-items:center;gap:10px;margin:10px 0;}
.checkbox-wrapper input[type="checkbox"]{width:auto;margin:0;}
.checkbox-wrapper label{margin:0;cursor:pointer;}
/* ===== NESTED POPUP ===== */
.nested-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 4000;
    align-items: center;
    justify-content: center;
}

.nested-popup-content {
    background: white;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    border-radius: 20px;
    padding: 20px;
    overflow-y: auto;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    animation: popIn 0.25s ease-out;
}

@keyframes popIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.nested-popup h3 {
    margin-bottom: 15px;
    color: #303021;
}
/* ===== FOOTER ===== */
.footer-nav { position: fixed; bottom: 0px; left: 50%; transform: translateX(-50%); height: 60px; width: 90%; max-width: 480px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; background: #303021; border-radius: 9999px; z-index: 1500; }
.left-group,.right-group{display:flex;justify-content:space-between;width:120px;gap:0;}
.footer-nav .switch-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:6px 0;width:50px;background:transparent;border:none;cursor:pointer;border-radius:12px;}
.footer-nav .switch-btn img{width:30px;height:30px;opacity:0.9; filter: invert(89%) sepia(12%) saturate(335%) hue-rotate(26deg) brightness(92%) contrast(88%);} 
.footer-nav .switch-btn span{color:#c6d197;font-weight:600;font-size:12px;} 
.footer-nav .switch-btn.active span{color:#8d4585;font-weight:700;}

/* ===== FLOATING CENTER BUTTON ===== */
.floating-center-btn{position:fixed;bottom:30px;left:50%;transform:translateX(-50%); width:60px;height:60px;border-radius:50%;background:#c1802a;border:none; display:flex;justify-content:center;align-items:center;font-size:36px;font-weight:700;color:#c6d197;cursor:pointer;z-index:2500;}

/* ===== TARIFS TABLE ===== */
#tarifsSheet table{width:100%;border-collapse:collapse;margin-top:10px;}
#tarifsSheet th,#tarifsSheet td{border:1px solid #8a8252;padding:8px;text-align:center;font-size:16px;}
#tarifsSheet th{background:#303021;color:#c6d197;font-weight:700;}

/* ===== AGENDA ===== */
#agendaSheet .agenda-wrap{ animation: slideUp 0.25s ease-out; }
.agenda-block{margin:6px 0;padding:10px;border-radius:12px;background:#fff;}
.agenda-day{padding:12px;border-radius:12px;margin-bottom:8px;border:1px solid #e6e2cf;}
.agenda-day h3{margin-bottom:8px;color:#303021;}
.agenda-entry {
    display: block; /* or inline-block */
    padding: 4px 8px;
    font-size: 16px;
    color: #303021;
}
.entry-time{width:110px;font-weight:700;color:#303021;}
.entry-body{flex:1;}
.entry-services{font-size:14px;color:#666;margin-top:4px;}

/* Today's special styling */
.agenda-today{background:linear-gradient(180deg,#fff9ee,#fff);border:2px solid #c1802a;box-shadow:0 6px 18px rgba(193,128,42,0.12);} 

/* Past dates less visible */
.agenda-past{opacity:0.45;}

/* moon icon style fallback */
.moon{font-size:16px;margin-left:8px;}

</style>
</head>
<body>

<div class="container">
<h2 id="monthHeader" class="month-header"></h2>
<div class="date-strip" id="dateStrip"></div>
<div class="summary">
      <div id="dailyTotal" style="margin-top: 10px; font-weight: 700;"></div>
</div>
</div>

<div id="serviceModal" class="modal">
  <div class="modal-content" id="modalContent">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
      <h2 style="margin-left:6px;">Servicios del DÃ­a</h2>
    </div>

    <div id="addedDogsContainer" style="margin-bottom:16px;"></div>

    <!-- Dog selector in main modal -->
    <div style="margin-bottom:70px;"> <!-- leave space for bottom button -->
      <select id="mainDogSelect" style="width:100%;padding:12px;font-size:16px;border:2px solid #c1802a;border-radius:8px;background:white;">
        <option value="">Seleccionar Perro</option>
      </select>
    </div>

    <!-- bottom back -->
    <button id="modalBackBtn" class="back-bottom-btn">Volver</button>
  </div>
</div>
    
<!-- NESTED ADD SERVICE POPUP -->
<div id="addServicePopup" class="nested-popup">
  <div class="nested-popup-content">
    <h3>AÃ±adir Servicio</h3>
    
    <label>Perro:</label>
    <select id="dogSelect">
      <option value="">Seleccionar Perro</option>
    </select>
    
    <label style="display:block;margin-top:15px;margin-bottom:8px;font-weight:600;">Servicios:</label>
    <div id="serviceButtonsContainer"></div>
    
    <div id="timeInputsContainer" style="display:none;margin-top:15px;">
      <label>Recogida:</label>
      <input id="startTimeInput" type="time" />
      <label>Entrega:</label>
      <input id="endTimeInput" type="time" />
    </div>
    
    <div class="controls-row" style="margin-top:20px;justify-content:flex-end;">
      <button id="cancelAddBtn" class="small-btn small-cancel">Cancelar</button>
      <button id="addDogBtn" class="small-btn small-save">Guardar</button>
    </div>
  </div>
</div>

<!-- TARIFS MODAL -->
<div id="tarifsSheet" class="modal">
  <div class="modal-content" id="tarifsContent">
    <h2>Tarifas</h2>
    <table id="tarifsTable">
      <thead>
        <tr><th>Perro</th><th>DÃ­a</th><th>Noche</th><th>Paseo</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="modal-buttons">
      <button id="addDogTarifBtn">AÃ±adir Perro</button>
      <button id="saveTarifsBtn">Guardar</button>
      <button id="closeTarifsBtn" class="cancel">Cancelar</button>
    </div>
  </div>
</div>

<!-- AGENDA MODAL (slides up) -->
<div id="agendaSheet" class="modal">
<div class="modal-content agenda-wrap" id="agendaContent">
<h2>Agenda Completa</h2>
<div id="agendaContainer"></div>
<div class="modal-buttons">
<button id="closeAgendaBtn" class="cancel">Cerrar</button>
</div>
</div>
</div>

<!-- FOOTER -->
<footer class="footer-nav">
  <div class="left-group">
    <button class="switch-btn tarifs" id="tarifsBtn"><img src="icons/bill.svg"><span>Tarifas</span></button>
    <button class="switch-btn accounts" id="accountsBtn"><img src="icons/accounts.svg"><span>Cuentas</span></button>
  </div>
  <div class="right-group">
    <button class="switch-btn profile" id="profileBtn"><img src="icons/folder.svg"><span>Perfiles</span></button>
    <button class="switch-btn calendar" id="calendarBtn"><img src="icons/calendar1.svg"><span>Agenda</span></button>
  </div>
</footer>

<button class="floating-center-btn" id="centralBtn">+</button>

<script>
// ===== GLOBAL STATE =====
let currentDate = new Date();
const defaultDogs = ["Nina","Carmela","Pancho","Pablo","Lili","Jugnia","Leo","India","Kimchi","Cuatri","Tristona y Belona","Neo","Briso","Zaspi","R&H"];
let allDogs = JSON.parse(localStorage.getItem('allDogs')) || defaultDogs;
let selections = JSON.parse(localStorage.getItem('selections')) || {};
let tarifs = JSON.parse(localStorage.getItem('tarifs')) || {};
let currentDogSelection = { dog: null, services: [], start: '', end: '' };
const formatDate = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;

// ===== DATE STRIP =====
const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const dateStrip = document.getElementById("dateStrip");
const DAYS_TO_SHOW = 365; // forward/back from today
let allDates = [];

function generateDates(centerDate = new Date()){
    allDates = [];
    for(let i=-DAYS_TO_SHOW;i<=DAYS_TO_SHOW;i++){
        const d = new Date(centerDate);
        d.setDate(centerDate.getDate() + i);
        allDates.push(d);
    }
}

function buildFullDateStrip(centerDate = new Date()){
    generateDates(centerDate);
    dateStrip.innerHTML = '';
    dateStrip.style.scrollSnapType = "x mandatory";

    allDates.forEach(d=>{
        const div = document.createElement("div");
        div.className = "date-item";
        if(d.toDateString() === centerDate.toDateString()) div.classList.add("active");
        div.innerHTML = `
            <span class="dayname">${dayNames[d.getDay()]}</span>
            <div class="circle">${d.getDate()}</div>
        `;
        dateStrip.appendChild(div);
    });

    setTimeout(()=>scrollToDate(centerDate),50);
}

function scrollToDate(targetDate){
    const items = dateStrip.querySelectorAll(".date-item");
    for(let i=0;i<allDates.length;i++){
        if(allDates[i].toDateString() === targetDate.toDateString()){
            const item = items[i];
            dateStrip.scrollLeft = item.offsetLeft - dateStrip.offsetWidth/2 + item.offsetWidth/2;
            break;
        }
    }
}

function updateMonthHeader(date){ document.getElementById("monthHeader").textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`; }

// Dragging behaviour
let isDragging = false; let startX, scrollLeft;
dateStrip.addEventListener('mousedown', (e)=>{ isDragging = true; startX = e.pageX - dateStrip.offsetLeft; scrollLeft = dateStrip.scrollLeft; });
dateStrip.addEventListener('touchstart', (e)=>{ isDragging = true; startX = e.touches[0].pageX - dateStrip.offsetLeft; scrollLeft = dateStrip.scrollLeft; });
dateStrip.addEventListener('mousemove', (e)=>{ if(!isDragging) return; e.preventDefault(); const x = e.pageX - dateStrip.offsetLeft; const walk = (x - startX); dateStrip.scrollLeft = scrollLeft - walk; });
dateStrip.addEventListener('touchmove', (e)=>{ if(!isDragging) return; const x = e.touches[0].pageX - dateStrip.offsetLeft; const walk = (x - startX); dateStrip.scrollLeft = scrollLeft - walk; });

dateStrip.addEventListener('mouseup', snapToClosest);
dateStrip.addEventListener('mouseleave', snapToClosest);
dateStrip.addEventListener('touchend', snapToClosest);

function snapToClosest(){ if(!isDragging) return; isDragging = false; const stripRect = dateStrip.getBoundingClientRect(); const stripCenter = stripRect.left + stripRect.width/2; let closestIdx = 0; let closestDist = Infinity; dateStrip.querySelectorAll('.date-item').forEach((item,i)=>{ const itemRect = item.getBoundingClientRect(); const itemCenter = itemRect.left + itemRect.width/2; const dist = Math.abs(stripCenter - itemCenter); if(dist < closestDist){ closestDist = dist; closestIdx = i; } }); const targetItem = dateStrip.children[closestIdx]; dateStrip.scrollTo({ left: targetItem.offsetLeft - dateStrip.offsetWidth/2 + targetItem.offsetWidth/2, behavior: 'smooth' }); dateStrip.querySelectorAll('.date-item').forEach(d=>d.classList.remove('active')); targetItem.classList.add('active'); currentDate = allDates[closestIdx]; updateMonthHeader(currentDate); updateSummary(); }

// ===== SERVICE MODAL =====
const serviceModal = document.getElementById('serviceModal');
const addServicePopup = document.getElementById('addServicePopup');
const mainDogSelect = document.getElementById('mainDogSelect');
const dogSelect = document.getElementById('dogSelect');
const serviceButtonsContainer = document.getElementById('serviceButtonsContainer');
const timeInputsContainer = document.getElementById('timeInputsContainer');
const addedDogsContainer = document.getElementById('addedDogsContainer');
const cancelAddBtn = document.getElementById('cancelAddBtn');
const addDogBtn = document.getElementById('addDogBtn');

// open main service modal
document.getElementById('centralBtn').onclick = ()=>{
    serviceModal.style.display='block';
    refreshServiceModalForCurrentDate();
    populateMainDogSelect();
};

// Populate the dog select in main modal
function populateMainDogSelect(){
    mainDogSelect.innerHTML = '<option value="">Seleccionar Perro</option>';
    allDogs.forEach(d=>{ 
        const opt = document.createElement('option'); 
        opt.value = d; 
        opt.textContent = d; 
        mainDogSelect.appendChild(opt); 
    });
}

// When dog is selected in main modal, open nested popup
mainDogSelect.onchange = ()=>{
    const selectedDog = mainDogSelect.value;
    if(!selectedDog) return;
    
    currentDogSelection = { dog: selectedDog, services: [], start: '', end: '' };
    dogSelect.innerHTML = '<option value="">Seleccionar Perro</option>';
    allDogs.forEach(d=>{ const opt = document.createElement('option'); opt.value = d; opt.textContent = d; dogSelect.appendChild(opt); });
    dogSelect.value = selectedDog;
    serviceButtonsContainer.innerHTML='';
    timeInputsContainer.style.display='none';
    document.getElementById('startTimeInput').value='';
    document.getElementById('endTimeInput').value='';
    renderServiceButtons();
    addServicePopup.style.display='flex';
    
    // Reset the main select
    mainDogSelect.value = '';
};
    
function renderServiceButtons() {
    serviceButtonsContainer.innerHTML = '';
    if (!currentDogSelection.dog) return;
    
    const services = ['GuarderÃ­a', 'Paseo', 'Otro servicio', '+1 Noche'];
    services.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'service-btn';
        btn.title = s;
        btn.textContent = s;

        btn.addEventListener('click', () => {
            btn.classList.toggle('selected');
            const idx = currentDogSelection.services.indexOf(s);
            if (idx > -1) currentDogSelection.services.splice(idx, 1);
            else currentDogSelection.services.push(s);
            
            // Only show time inputs if a service requiring time is selected
            const needsTime = currentDogSelection.services.some(
                service => service !== '+1 Noche'
            );
            timeInputsContainer.style.display = needsTime ? 'block' : 'none';
        });

        serviceButtonsContainer.appendChild(btn);
    });
}
    
// CANCEL button - closes nested popup without saving
cancelAddBtn.addEventListener('click', () => {
    addServicePopup.style.display = 'none';
});

// SAVE button - saves selection and closes nested popup
addDogBtn.addEventListener('click', (e) => {
    e.preventDefault(); // prevent any default form behavior
    if (!currentDogSelection.dog || currentDogSelection.services.length === 0) {
        alert('Selecciona un perro y al menos un servicio');
        return;
    }
    currentDogSelection.start = document.getElementById('startTimeInput').value || '';
    currentDogSelection.end = document.getElementById('endTimeInput').value || '';

    const dateKey = formatDate(currentDate);
    if (!selections[dateKey]) selections[dateKey] = {};
    currentDogSelection.services.forEach(s => {
        const key = `${currentDogSelection.dog}_${s}`;
        selections[dateKey][key] = {
            selected: true,
            start: currentDogSelection.start,
            end: currentDogSelection.end
        };
    });
    localStorage.setItem('selections', JSON.stringify(selections));

    renderAddedDogsForDate(dateKey);
    updateSummary();

    addServicePopup.style.display = 'none'; // close nested popup
});


// VOLVER button - closes the entire main service modal
document.getElementById('modalBackBtn').addEventListener('click', () => {
    serviceModal.style.display = 'none';
});

function renderAddedDogsForDate(dateKey){
    addedDogsContainer.innerHTML='';
    const entries = selections[dateKey] || {};
    
    Object.entries(entries).forEach(([k,v])=>{
        if(!v.selected) return;
        const [dog, service] = k.split('_');
        const timeStr = v.start || v.end ? ` ${v.start || ''}${v.start && v.end ? ' - ' : ''}${v.end || ''}` : '';
        const card = document.createElement('div');
        card.className = 'dog-entry';
        card.innerHTML = `<div><strong>${dog}</strong><div class="services-list">${service}${timeStr}</div></div><div><button class="remove-btn">Eliminar</button></div>`;
        const removeBtn = card.querySelector('.remove-btn');
        if(removeBtn) removeBtn.addEventListener('click', ()=>{ 
            delete selections[dateKey][k]; 
            localStorage.setItem('selections', JSON.stringify(selections)); 
            renderAddedDogsForDate(dateKey); 
            updateSummary(); 
        });
        addedDogsContainer.appendChild(card);
    });
}

// show existing for current date when modal opens or date changes
function refreshServiceModalForCurrentDate(){ 
    const dateKey = formatDate(currentDate); 
    renderAddedDogsForDate(dateKey); 
}

// ===== SUMMARY =====
function updateDailyTotal(date) {
    const dateKey = formatDate(date);
    const entries = selections[dateKey] || {};
    let total = 0;

    Object.entries(entries).forEach(([key, val]) => {
        if (!val.selected) return;
        const [dog, service] = key.split('_');
        const dogTarif = tarifs[dog] || { day: 0, night: 0, walk: 0 };
        if (service.toLowerCase().includes('guarderÃ­a') || service.toLowerCase().includes('day')) total += dogTarif.day || 0;
        else if (service.toLowerCase().includes('paseo') || service.toLowerCase().includes('walk')) total += dogTarif.walk || 0;
        else if (service.toLowerCase().includes('noche') || service.toLowerCase().includes('night')) total += dogTarif.night || 0;
    });

    document.getElementById('dailyTotal').textContent = `Total diario: â‚¬${total}`;
}

function updateSummary() {
    const dateKey = formatDate(currentDate);
    const div = document.getElementById('summaryContent');
    if(!selections[dateKey]){
        div.textContent = 'No hay servicios seleccionados.';
    } else {
        const groups = {};
        Object.entries(selections[dateKey]).forEach(([key,val])=>{
            if(!val.selected) return;
            const [dog, service] = key.split('_');
            if(!groups[dog]) groups[dog]=[];
            const timeStr = val.start || val.end ? ` (${val.start || ''} - ${val.end || ''})` : '';
            groups[dog].push(`${service}${timeStr}`);
        });

        let html='';
        for(let dog in groups){
            html += `<strong>${dog}</strong><br>`;
            groups[dog].forEach(s=>{ html+=`â€¢ ${s}<br>`; });
            html+='<br>';
        }
        div.innerHTML = html || 'No hay servicios seleccionados.';
    }

    // Separate call for the total
    updateDailyTotal(currentDate);
}
// ===== TARIFS MODAL =====
const tarifsSheet = document.getElementById('tarifsSheet');
const tarifsTableBody = document.querySelector('#tarifsTable tbody');

function loadTarifs(){
    tarifsTableBody.innerHTML='';
    allDogs.forEach(d=>{
        if(!tarifs[d]) tarifs[d]={day:10,night:10,walk:10};
        const row = document.createElement('tr');
        row.innerHTML = `<td>${d}</td><td><input type="number" min="0" value="${tarifs[d].day}"></td><td><input type="number" min="0" value="${tarifs[d].night}"></td><td><input type="number" min="0" value="${tarifs[d].walk}"></td>`;
        tarifsTableBody.appendChild(row);
    });
}
loadTarifs();

document.getElementById('tarifsBtn').onclick = ()=>{ tarifsSheet.style.display='block'; document.getElementById('tarifsContent').style.animation = 'slideUp 0.30s ease-out'; };
document.getElementById('closeTarifsBtn').onclick = ()=>{ tarifsSheet.style.display='none'; };
document.getElementById('saveTarifsBtn').onclick = ()=>{ [...tarifsTableBody.querySelectorAll('tr')].forEach(tr=>{ const dog = tr.children[0].textContent; tarifs[dog] = { day: Number(tr.children[1].querySelector('input').value), night: Number(tr.children[2].querySelector('input').value), walk: Number(tr.children[3].querySelector('input').value) }; }); localStorage.setItem('tarifs',JSON.stringify(tarifs)); tarifsSheet.style.display='none'; };
document.getElementById('addDogTarifBtn').onclick = ()=>{ const name = prompt("Introduce el nombre del perro:"); if(!name) return; if(allDogs.includes(name)){ alert("Perro ya existe."); return; } allDogs.push(name); localStorage.setItem('allDogs',JSON.stringify(allDogs)); tarifs[name] = {day:10, night:10, walk:10}; loadTarifs(); };

// ===== AGENDA MODAL =====
const agendaSheet = document.getElementById('agendaSheet');
const agendaContainer = document.getElementById('agendaContainer');


document.getElementById('calendarBtn').onclick = ()=>{ openAgenda(); };
document.getElementById('closeAgendaBtn').onclick = ()=>{ agendaSheet.style.display='none'; };


function openAgenda(){
renderAgenda();
agendaSheet.style.display='block';
document.getElementById('agendaContent').style.animation = 'slideUp 0.25s ease-out';
}


function renderAgenda() {
    agendaContainer.innerHTML = '';
    const dateKeys = Object.keys(selections);
    if(dateKeys.length === 0){
        agendaContainer.innerHTML = '<p>No hay servicios programados.</p>';
        return;
    }

    const now = new Date();
    now.setHours(0,0,0,0);

    let todayBlock = null;
    const future = [];

    dateKeys.forEach(k => {
        const [da, ma, ya] = k.split('/').map(Number);
        const dt = new Date(ya, ma-1, da);
        if(dt.getTime() === now.getTime()) todayBlock = k;
        else if(dt > now) future.push(k);
    });

    // Today's block
    if(todayBlock){
        const todaySection = document.createElement('div');
        todaySection.className = 'agenda-block agenda-today';
        const dayDiv = buildAgendaDay(todayBlock, false, true);
        todaySection.appendChild(dayDiv);
        agendaContainer.appendChild(todaySection);
    }

    // Future block
    future.forEach(fk => {
        const futureSection = document.createElement('div');
        futureSection.className = 'agenda-block';
        const dayDiv = buildAgendaDay(fk, false);
        futureSection.appendChild(dayDiv);
        agendaContainer.appendChild(futureSection);
    });
}

function buildAgendaDay(dateKey, isPast=false, isToday=false){
    const dayDiv = document.createElement('div');
    dayDiv.className = 'agenda-day';
    if(isPast) dayDiv.classList.add('agenda-past');
    
    const header = document.createElement('h3');
    header.textContent = dateKey + (isToday ? ' (Hoy)' : '');
    dayDiv.appendChild(header);

    const entries = selections[dateKey] || {};
    // Convert entries to array and sort: no time first, then by start time
    const sortedEntries = Object.entries(entries)
        .filter(([key,val]) => val.selected)
        .map(([key,val]) => {
            const [dog, service] = key.split('_');
            return { dog, service, start: val.start, end: val.end };
        })
        .sort((a,b) => {
            if(!a.start && b.start) return -1;       // a has no start â†’ comes first
            if(a.start && !b.start) return 1;        // b has no start â†’ comes first
            return a.start.localeCompare(b.start);    // both have time â†’ sort by start
        });

sortedEntries.forEach(e => {
    const entry = document.createElement('div');
    entry.className = 'agenda-entry';
    const timeStr = e.start ? e.start : '';
    const endStr = e.end ? ` - ${e.end}` : '';
    const serviceStr = e.service === 'Overnight' ? `${e.service} ðŸŒ™` : e.service;
    entry.textContent = `${timeStr}${endStr} ${e.dog} ${serviceStr}`;
    dayDiv.appendChild(entry);
});

    return dayDiv;
}


// ===== INITIAL CALLS =====
buildFullDateStrip(currentDate);
updateMonthHeader(currentDate);
updateSummary();

// when opening service modal for a date, refresh added list
// listen to date strip clicks to update currentDate and refresh summary
dateStrip.addEventListener('click', (e)=>{ // find nearest .date-item with center snapping already handled in drag; here capture click
    const item = e.target.closest('.date-item'); if(!item) return; const idx = Array.from(dateStrip.children).indexOf(item); if(idx>=0){ currentDate = allDates[idx]; dateStrip.querySelectorAll('.date-item').forEach(d=>d.classList.remove('active')); item.classList.add('active'); updateMonthHeader(currentDate); updateSummary(); refreshServiceModalForCurrentDate(); }
});

// open service modal should also show existing for date
document.getElementById('centralBtn').addEventListener('click', ()=>{ refreshServiceModalForCurrentDate(); });

// open agenda via button
document.getElementById('calendarBtn').addEventListener('click', ()=>{ openAgenda(); });

</script>

</body>
</html>
